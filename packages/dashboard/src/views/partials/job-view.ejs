<section class="space-y-6"
  id="job-details"
  hx-get="/jobs/<%= job.id %>"
  hx-swap="outerHTML"
  hx-trigger="every 3s, jobChanged"
>
  <div class="flex w-full">
    <h1 class="text-2xl font-bold flex-1">
      #<%= job.id %> - <%= job.class %>
      <span class="badge <%= {
        completed: 'badge-success',
        failed: 'badge-error',
        canceled: 'badge-secondary',
        pending: 'badge-warning',
        claimed: 'badge-info',
        running: 'badge-primary',
      }[job.state] || 'badge-neutral' %>">                
      <%= job.state.charAt(0).toUpperCase() + job.state.slice(1) %>
    </span>
    </h1>
    <div class="flex justify-end space-x-2">
      <% if (!['canceled', 'failed', 'completed'].includes(job.state)){ %>
      <button class="btn btn-sm btn-outline" hx-patch="/jobs/<%= job.id %>/cancel"><i data-feather="x" class="w-4 h-4"></i>Cancel</button>
      <% } %>
      <% if (job.available_at > new Date()) { %>
      <button type="button" class="btn btn-sm btn-outline" hx-patch="/jobs/<%= job.id %>/run"><i data-feather="play" class="w-4 h-4"></i>Run</button>
      <% } %>
      <% if (['canceled', 'failed', 'completed'].includes(job.state)){ %>
        <button class="btn btn-sm btn-outline" hx-patch="/jobs/<%= job.id %>/rerun"><i data-feather="refresh-ccw" class="w-4 h-4"></i>Re-Run</button>
        <% } %>
    </div>
  </div>
  <div class="card bg-neutral text-neutral-content shadow-lg">
    <div class="card-body">
      <ul class="steps steps-vertical lg:steps-horizontal">
  
        <li class="step <%= job.state === 'completed' ? 'step-success' : 'step-primary' %>">
          <span class="step-icon">
            <i data-feather="clock" class="w-4 h-4"></i>
          </span>
          Enqueued
        </li>
  
        <li class="step <%= job.state === 'completed' ? 'step-success' : (['claimed', 'running', 'failed', 'canceled'].includes(job.state) ? 'step-primary' : '') %>">
          <span class="step-icon">
            <i data-feather="user-check" class="w-4 h-4"></i>
          </span>
          Claimed
        </li>
  
        <li class="step <%= job.state === 'completed' ? 'step-success' : (['running', 'failed', 'canceled'].includes(job.state) ? 'step-primary' : '') %>">
          <span class="step-icon">
            <i data-feather="activity" class="w-4 h-4"></i>
          </span>
          Running
        </li>
  
        <% if (job.state === 'completed') { %>
          <li class="step step-success">
            <span class="step-icon">
              <i data-feather="check-circle" class="w-4 h-4"></i>
            </span>
            Completed
          </li>
        <% } else if (job.state === 'failed') { %>
          <li class="step step-error">
            <span class="step-icon">
              <i data-feather="x-circle" class="w-4 h-4"></i>
            </span>
            Failed
          </li>
        <% } else if (job.state === 'canceled') { %>
          <li class="step step-secondary">
            <span class="step-icon">
              <i data-feather="alert-circle" class="w-4 h-4"></i>
            </span>
            Canceled
          </li>
        <% } else { %>
          <li class="step">
            <span class="step-icon">
              <i data-feather="check-circle" class="w-4 h-4"></i>
            </span>
            Completed
          </li>
        <% } %>
      </ul>
    </div>
  </div>
  

  <div class="card bg-neutral text-neutral-content shadow-lg">
    <div class="card-body">
      <h3 class="card-title text-lg font-semibold">Job Details</h3>

      <div class="space-y-2 text-sm">
        <div>
          <span class="font-semibold text-sm mb-1">Class:</span>
          <span class="font-mono text-base-content ml-1"><%= job.class %></span>
        </div>
      
        <div>
          <span class="font-semibold text-sm mb-1">Script:</span>
          <span class="font-mono text-base-content ml-1"><%= job.script %></span>
        </div>
      
        <div>
          <span class="font-semibold text-sm mb-1">Attempts:</span>
          <span class="text-base-content ml-1"><%= job.attempt %> / <%= job.max_attempts %></span>
        </div>
      </div>
  
      <div class="mt-5">
        <h4 class="text-sm font-semibold mb-1">Constructor Arguments</h4>
      
        <% if (Array.isArray(job.constructor_args) && job.constructor_args.length > 0) { %>
          <div id="constructor-details" class="sq-code bg-neutral-900 rounded p-3 text-xs font-mono">
            <div class="code-content overflow-x-auto max-h-[15rem] overflow-hidden transition-all">
              <pre><code class="language-json"><%= JSON.stringify(job.constructor_args, null, 2) %></code></pre>
            </div>
            <div>
              <button class="toggle-btn mt-2 btn btn-xs btn-outline btn-primary self-end">See more</button>
            </div>
          </div>
        <% } else { %>
          <p class="text-xs text-neutral-content italic">No arguments</p>
        <% } %>
      </div>

      <div class="mt-5">
        <h4 class="text-sm font-semibold mb-1">Run Arguments</h4>
        <% if (Array.isArray(job.args) && job.args.length > 0) { %>
          <div id="args-details" class="sq-code bg-neutral-900 rounded p-3 text-xs font-mono">
            <div class="code-content overflow-x-auto max-h-[15rem] overflow-hidden transition-all">
              <pre><code class="language-json"><%= JSON.stringify(job.args, null, 2) %></code></pre>
            </div>
            <div>
              <button class="toggle-btn mt-2 btn btn-xs btn-outline btn-primary self-end">See more</button>
            </div>
          </div>
        <% } else { %>
          <p class="text-xs text-neutral-content italic">No arguments</p>
        <% } %>
      </div>


      <% if (job.result) { %>
        <div>
          <h4 class="text-sm font-semibold mb-1">Result</h4>
          <div id="result-details" class="sq-code bg-neutral-900 rounded p-3 text-xs font-mono">
            <div class="code-content overflow-x-auto max-h-[15rem] overflow-hidden transition-all">
              <pre><code class="language-json"><%= JSON.stringify(job.result, null, 2) %></code></pre>
            </div>
            <div>
              <button class="toggle-btn mt-2 btn btn-xs btn-outline btn-primary self-end">See more</button>
            </div>
          </div>
        </div>        
      <% } %>

      <% if (job.errors && job.errors.length > 0) { %>
        <div>
          <h4 class="text-sm font-semibold mb-1">Errors</h4>
          <div class="bg-neutral-900 rounded p-3 text-xs text-base-content space-y-2 font-mono">
            <% job.errors.forEach((err, idx) => { %>
              <div class="border-b border-neutral/30 pb-2 mb-2 last:border-none last:pb-0 last:mb-0">
                <div>
                  <span class="text-error font-medium"><%= err.message %></span>
                  <span class="text-neutral-content ml-2">at <%= err.timestamp %></span>
                </div>
                <div class="text-neutral-content">
                  Attempt <%= err.attempt %> by <%= err.attempt_by %>
                </div>
                <% if (err.stack) { %>
                  <details id="details-for-<%= err.attempt %>" class="mt-1">
                    <summary class="cursor-pointer text-primary">Stack Trace</summary>
                    <pre class="bg-neutral-950 rounded p-2 mt-1 text-[11px] overflow-x-auto whitespace-pre-wrap text-base-content">
      <%- err.stack %>
                    </pre>
                  </details>
                <% } %>
              </div>
            <% }) %>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</section>